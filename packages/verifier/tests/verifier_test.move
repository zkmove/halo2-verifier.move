#[test_only]
module halo2_verifier::verifier_test {
    use std::bn254_algebra::{G1, FormatG1Uncompr, G2, FormatG2Uncompr};
    use std::option;
    use std::vector;

    use aptos_std::crypto_algebra;

    use halo2_common::params;
    use halo2_verifier::halo2_verifier;
    use halo2_verifier::protocol;

    // the following param data is generated from `crates/vk-gen-examples/params/challenge_0078-kzg_bn254_16.srs`
    // they all in uncompressed form.
    #[test_only]
    const TESTING_G1: vector<u8> = x"01000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000";
    #[test_only]
    const TESTING_G2: vector<u8> = x"edf692d95cbdde46ddda5ef7d422436779445c5e66006a42761e1f12efde0018c212f3aeb785e49712e7a9353349aaf1255dfb31b7bf60723a480d9293938e19aa7dfa6601cce64c7bd3430c69e7d1e38f40cb8d8071ab4aeb6d8cdba55ec8125b9722d1dcdaac55f38eb37033314bbc95330c69ad999eec75f05f58d0890609";
    #[test_only]
    const TESTING_S_G2: vector<u8> = x"e4115200acc86e7670c83ded726335def098657fe8668323e9e41e6781b83b0a9d83b54bbb00215323ce6d7f9d7f331a286d7707d03f7dbdd3125c6163588d13ed1abbe32fb3f9c8817d1ae305b395f5ff1db05263b9879602dc18c92e73d916ee07a11fd87eaa69ae764c48f7d618d1d531a4956eed421efcf2491a99769a16";

    #[test(s = @aptos_std)]
    public fun check_verify_ok(s: &signer) {
        crypto_algebra::enable_cryptography_algebra_natives(s);
        let params = params::new(
            option::destroy_some(crypto_algebra::deserialize<G1, FormatG1Uncompr>(&TESTING_G1)),
            option::destroy_some(crypto_algebra::deserialize<G2, FormatG2Uncompr>(&TESTING_G2)),
            option::destroy_some(crypto_algebra::deserialize<G2, FormatG2Uncompr>(&TESTING_S_G2))
        );
        // protocol of example vector-mul
        // generated by `cargo run --release --  --param-path params/challenge_0078-kzg_bn254_16.srs --verifier-address 0xcfae5b6bd579e7aff4274aeca434bb500c024b89c139b545c6eeb27bfafea8c1 build-publish-vk-aptos-txn --example vector-mul -o vk_deployment`
        let protocol = protocol::from_bytes(vector[
            x"0f040b991d2f930e735f0028ac957fb7ab6707474ed4eedbfe4f7cbb391c6f07",
            x"baaa5c0c4c452e320267ee0a90b648c30821c86d8627359fcb32e13deb83ad02",
            x"8703f8f88dac3610100dfbe5bb52498335e94896d2268e0128976bb88e15ec1bd7e110682012410aaebe615ee56d487414c5cdf4edc3ea7c94c18898207f750438eb14dd26e292dc9e41920db4619a83a4b6c5691825d26cc4a33fb29ccd69499a8c64ea83540da5130cd2f098126287ba27fc2f51dd20bc9fc7fe5bdfb3dd51",
            x"10",
            x"01000000",
            x"03000000",
            x"0100000000000000",
            x"0100000000000000",
            x"000000",
            x""
        ],
            vector[
                x"00000000000100000000",
                x"00010000000100000000",
                x"00020000000100000000"
            ],
            vector[
                x"f4000000000100000000"
            ],
            vector[x"ff000000000100000000"],
            vector[
                x"f400000000",
                x"0000000000",
                x"0001000000",
                x"0002000000"
            ],
            vector[],
            vector[
                x"0000080200070803000301060302"
            ],
            vector[],
            vector[],
            vector[],
            vector[]
        );
        let proof_gwc = x"06661ff6e3bd260e8dc4f9096034eaf96782d3fed55ec7fbc5928d2a8de1dd5ce1563c6c4fbc544a0544f957202b6cdcfb0b2e203ba886694a19542d8f749c2d9d0fe09c16f5172e45e48f82f28679649c482ae4baacec0c4d5514711eb4aa255508673b9a378da619ab1d60b24a077e7d4489f19e8b6610542d92ff65bb8d6b5442ab04b452a5199776c980dafb6e6ef641b08ce72c0c1560256b552a2a0520ce48ece7c5dd11faa9945ef0cdaffe033d613b6ee01a9584338a37dc189b6954e0fb075b65df7afa31f16a23fdda32d53accf86e4ab33c64b9237f9c77173267ce4d15888440edac1fb6c68a89c7d6064168e5d9f75e1a1145302b0152acf82a0af1768791ba83b2af7dd6017abf50b1a76a33c1a1e4c67aa45b112525bfd04199e7edf57761823f0631982d7d1697f8566cd3fc5b4cf51483eef3f043edba6427146897c39fef248906393e6432fea6fe06512691f951c284fec2925d73a6130c9d277300882e6851460f84478d312a444dad1df2538e92968b8ea553b2bb2fb9b422a265721ec590e239f4d56ae149969965f67f2feade42e802973a3b9802ad1b22028d99a296f53b099dbadaa219678bbbb645586987c2698c975a60231719cc6bdccaaf7d324de8f7a3b1d341a5e1381900bcf88094aa771b87911dd4227783301342491442d31acf2b2022944e30ebe9439f73b2e4bfc80a12d4de7013a73b77797f1208e1e4b88b02aec8b5c85dbae913b55dd08f2fed2363afdf0208cab543b662ae9158637203dd6ad77dc049ca7770d6751de20c9cc54cea9d4912f82b43090a9cd174edd4b60c7b165d2a80d48d013835d8a9cf1271567fb2c91fe5f085c44f5b7e2635d284b21cb6452906227601ca585e8ddd3a5b0150c84e0e2e45ae48d038ff74a2dac1a862394c430cc37e19d062e39c69bcc48a11285d17ce446616ec4f9ef25f426d3446ec2c3ad1931991760d0ea538176618202a471bd105ad235590a53d50d8d497f77d40a943b8ba2d4543d6f7548a6137040cf7145656913e53b8cb3b7ef81e4581a3a27d9053a3d14447b9d6ae5d37c42c62612a2f57b718f3a0f604d55b046e9dec1c1007c9d67756afdfea7c5459c6309ae92f165c32f377d692d25d895ff502e9a33687f05d7398466e83bd7746b46318ea01433a3f57d53a9d62aef5e755dbf5b838403ff0d725f9523e04316369ab75f92bb173e99f30ac90d05f44cd5b5b188585f08dbdcda8003c5b46ed939504830c2e2f8bad480e3bec5806bc124ea7542d3a27eea0edf02c65abe2fc447850a0e328d8616a9772d0c1d0d20ca6164f81e943da26774ba5b0e37aa70f46cd3ba47811285b4d60c04ce22089b9df64b9625369e67887431b8c81536feb200031e2c22dbad8ae253d3bcef176657dccc0cd756874c99d68316b44e65a54c9e3002980523d23d9c66ac2e1d4d3a19d486d1c437a45a44a847339fe636b6eefc6ab93570a";
        let proof_shplonk = x"06661ff6e3bd260e8dc4f9096034eaf96782d3fed55ec7fbc5928d2a8de1dd5ce1563c6c4fbc544a0544f957202b6cdcfb0b2e203ba886694a19542d8f749c2d9d0fe09c16f5172e45e48f82f28679649c482ae4baacec0c4d5514711eb4aa255508673b9a378da619ab1d60b24a077e7d4489f19e8b6610542d92ff65bb8d6b5442ab04b452a5199776c980dafb6e6ef641b08ce72c0c1560256b552a2a0520ce48ece7c5dd11faa9945ef0cdaffe033d613b6ee01a9584338a37dc189b6954e0fb075b65df7afa31f16a23fdda32d53accf86e4ab33c64b9237f9c77173267ce4d15888440edac1fb6c68a89c7d6064168e5d9f75e1a1145302b0152acf82a0af1768791ba83b2af7dd6017abf50b1a76a33c1a1e4c67aa45b112525bfd04199e7edf57761823f0631982d7d1697f8566cd3fc5b4cf51483eef3f043edba6427146897c39fef248906393e6432fea6fe06512691f951c284fec2925d73a6130c9d277300882e6851460f84478d312a444dad1df2538e92968b8ea553b2bb2fb9b422a265721ec590e239f4d56ae149969965f67f2feade42e802973a3b9802ad1b22028d99a296f53b099dbadaa219678bbbb645586987c2698c975a60231719cc6bdccaaf7d324de8f7a3b1d341a5e1381900bcf88094aa771b87911dd4227783301342491442d31acf2b2022944e30ebe9439f73b2e4bfc80a12d4de7013a73b77797f1208e1e4b88b02aec8b5c85dbae913b55dd08f2fed2363afdf0208cab543b662ae9158637203dd6ad77dc049ca7770d6751de20c9cc54cea9d4912f82b43090a9cd174edd4b60c7b165d2a80d48d013835d8a9cf1271567fb2c91fe5f085c44f5b7e2635d284b21cb6452906227601ca585e8ddd3a5b0150c84e0e2e45ae48d038ff74a2dac1a862394c430cc37e19d062e39c69bcc48a11285d17ce446616ec4f9ef25f426d3446ec2c3ad1931991760d0ea538176618202a471bd105ad235590a53d50d8d497f77d40a943b8ba2d4543d6f7548a6137040cf7145656913e53b8cb3b7ef81e4581a3a27d9053a3d14447b9d6ae5d37c42c62612a2f57b718f3a0f604d55b046e9dec1c1007c9d67756afdfea7c5459c6309ae92f165c32f377d692d25d895ff502e9a33687f05d7398466e83bd7746b46318ea01433a3f57d53a9d62aef5e755dbf5b838403ff0d725f9523e04316369ab75f92bb173e99f30ac90d05f44cd5b5b188585f08dbdcda8003c5b46ed939504830c2e2f8bad480e3bec5806bc124ea7542d3a27eea0edf02c65abe2fc447850a0e328d8616a9772d0c1d0d20ca6164f81e943da26774ba5b0e37aa70f46cd3ba47811880881802ef812ba8cf92c2cc572d66b91c8caf40b309113042234b947582d449bf3203c31b4b86ba734c32f9df2bd6d180bb3333caf7f575dbe186f78db9440";

        let instances = vector[
            x"0600000000000000000000000000000000000000000000000000000000000000",
            x"0600000000000000000000000000000000000000000000000000000000000000",
            x"0600000000000000000000000000000000000000000000000000000000000000"
        ];
        let result = halo2_verifier::verify_single(&params, &protocol, vector::singleton(instances), proof_gwc, 1);
        assert!(result, 100);
        let result = halo2_verifier::verify_single(&params, &protocol, vector::singleton(instances), proof_shplonk, 0);
        assert!(result, 101);
    }
}
