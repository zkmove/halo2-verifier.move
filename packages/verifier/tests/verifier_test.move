#[test_only]
module halo2_verifier::verifier_test {
    use std::bn254_algebra::{G1, FormatG1Uncompr, G2, FormatG2Uncompr};
    use std::option;
    use std::vector;

    use aptos_std::crypto_algebra;

    use halo2_common::params;
    use halo2_verifier::halo2_verifier;
    use halo2_verifier::protocol;

    // the following param data is generated from `crates/vk-gen-examples/params/challenge_0078-kzg_bn254_16.srs`
    // they all in uncompressed form.
    #[test_only]
    const TESTING_G1: vector<u8> = x"01000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000";
    #[test_only]
    const TESTING_G2: vector<u8> = x"edf692d95cbdde46ddda5ef7d422436779445c5e66006a42761e1f12efde0018c212f3aeb785e49712e7a9353349aaf1255dfb31b7bf60723a480d9293938e19aa7dfa6601cce64c7bd3430c69e7d1e38f40cb8d8071ab4aeb6d8cdba55ec8125b9722d1dcdaac55f38eb37033314bbc95330c69ad999eec75f05f58d0890609";
    #[test_only]
    const TESTING_S_G2: vector<u8> = x"e4115200acc86e7670c83ded726335def098657fe8668323e9e41e6781b83b0a9d83b54bbb00215323ce6d7f9d7f331a286d7707d03f7dbdd3125c6163588d13ed1abbe32fb3f9c8817d1ae305b395f5ff1db05263b9879602dc18c92e73d916ee07a11fd87eaa69ae764c48f7d618d1d531a4956eed421efcf2491a99769a16";

    #[test(s = @aptos_std)]
    public fun check_verify_ok(s: &signer) {
        crypto_algebra::enable_cryptography_algebra_natives(s);
        let params = params::new(
            option::destroy_some(crypto_algebra::deserialize<G1, FormatG1Uncompr>(&TESTING_G1)),
            option::destroy_some(crypto_algebra::deserialize<G2, FormatG2Uncompr>(&TESTING_G2)),
            option::destroy_some(crypto_algebra::deserialize<G2, FormatG2Uncompr>(&TESTING_S_G2))
        );
        // protocol of example vector-mul
        // generated by `cargo run --release --  --param-path params/challenge_0078-kzg_bn254_16.srs --verifier-address 0xcfae5b6bd579e7aff4274aeca434bb500c024b89c139b545c6eeb27bfafea8c1 build-publish-vk-aptos-txn --example vector-mul -o vk_deployment`
        let protocol = protocol::from_bytes(
            vector[
                x"3f8c4673ba5c3eb53ddb38c02cfa47483c4d6a25fbc64ea44c50309fbd413d2c",
                x"a7c40e6e753cfd404ff8e10e1352a3eb77c8e0495bf1d9b7c67410ce4f2a5a98",
                x"f1ad77997188215fb04be428716b389ff29c6ef944e36ab74ffaa9d192d324858d6c5ae20545006f1f4c93446419c848a95dd8e567a2990c1cba488d4a196f0fa9f81ad6c30148acd3011bfd4d6f9a129c577dd059acb81a26d86e7afab696aba66350b2d5606122fa883ea1232fc384ffae8f8e3db990ef760506abf2f5f284",
                x"0c",
                x"01000000",
                x"03000000",
                x"0100000000000000",
                x"0100000000000000",
                x"000000",
                x"",
                x"00",
                x"00"
            ],
            vector[
                x"01000000000100000000",
                x"01010000000100000000",
                x"01020000000100000000"
            ],
            vector[
                x"03000000000100000000"
            ],
            vector[x"02000000000100000000"],
            vector[
                x"0300000000",
                x"0100000000",
                x"0101000000",
                x"0102000000"
            ],
            vector[],
            vector[
                x"080200070803000301060302"
            ],
            vector[],
            vector[],
            vector[],
            vector[]
        );
        let proof_gwc = x"3681c1d1817d8b98dd7b522ccecf2cf190a4a8e1cf6f8a743b7acdcab33e26132211205f30ce2b988edbc8bcea6b4c5970280f1aa1b8248264ca8e265575878d00bd3fc17b08e9dd6bd7f6484ab6a79997c68d542eacd86167eb42d169f42690917e64f9a25d79b2a35c01e50fd522cf1e0f1972a268ab99fc2a66fab4c1fbaac7f928a6bbe3678f2210aca958e4274b36cbabecc23249c146db0e5c6d5f0e8e27b134238e08c4edf54b874dd1d5a0176872fd428d2e72765a86ed36f1c82600435ffc17a391a89cdc95642ce72e58ef8f6a8d13844e730c75d291e30bf4dca2137aded2207d1fc5226f90535c4758d1dc436edda9f049067bbb465c747c6001d61e52ea8e5c441ed55f4244c85b515f7fd28229641b829594e612783292440da0457df8f2ca01b837c681e9a8f34bb722082aa62b0f7a6eaaf9b874197f309707266faa9f823e2d4ded37f2a001ebbc2bc1e58a912673e088d643ee5af23a1a7aec68c383498a080b617c98af567a96510c1f5ac6988fb2cdc7a6af0ee1fd26f4e8557b441079497d91be7c59810c3148c9a479f893261e7c0c5ee008577f2718fd4aaa5ba24c4421962a05be3e0ec807f7f46aa55ca1b5bb78cf5a6bc27b0139d5e24bca1b57b1d66bd3c3ad17d6c219c85d14f8ce7311ad1f12453db020300d119d602a3bb5ed00f1b0718bbff5ff03ebe3d65f8d94200769bd1f90a4952dbd5f54d0adb5c309fe6e01fc24f9baef6c6b571c8049f234c0c139bc01a3df293805bb83f48a4c26fca011e67bf7080f01ad3151725c4a391f97a0d7b34d3517e16a4cec8a676c67a133c3d42ec2d644b05feaa6ac0ca09c44134fe77740bc19abd4a981d7fd95cebb4bee3787d9d163e57d161ded20203f5ab3f051ecfec71a4cb0716ada6eca73949c893f83a75d6a69b918604876359076cc58817baa8828a3e127b5111be026655ae8edefd79ced3e5bd05521bdbe3198404327c0408f161b6a98303867cb77b3e6ce674a457b0ecd738107db2966534797adb039b48d0d8fe6df89f67d84f42cb19b2d3799b168ef550450f878b59e4fe1bb9c8d64871e896eedc50241740c64cbab5aa2415043ef5c095529370fb03adbc6ec8e22852c7aa92729889a956df02a7fdc66db20d151805e7afb33e9d4c53ea41fa90bf822ea572c361cf6136c7d6ba50275bff40721f888216b4d19f3dd18d7768a41b2053039e17cdbd0d70721e76224f2bb5b541c03123da922b23948b98a05a92bec0eb917bf500dd0947ca27863faf9eed01a7d81852a3016bc0e1a36457ccb6632278448d6e99bd631cbd007de80ce1b693601b723a8e3b2c75f781bc2124ee7cc076e6b66d210a85d8adae856bf722facb2d811332ab1f343f8a28d94a926ca229d652dc60060c241e7548394cd4885a67f725551a85048295e012b333ab297fd007f77e22ecb19e7ef1ee6a7cbdc3e9945beb9638ef065a697c46d79c0de01a793";
        let proof_shplonk = x"3681c1d1817d8b98dd7b522ccecf2cf190a4a8e1cf6f8a743b7acdcab33e26132211205f30ce2b988edbc8bcea6b4c5970280f1aa1b8248264ca8e265575878d00bd3fc17b08e9dd6bd7f6484ab6a79997c68d542eacd86167eb42d169f42690917e64f9a25d79b2a35c01e50fd522cf1e0f1972a268ab99fc2a66fab4c1fbaac7f928a6bbe3678f2210aca958e4274b36cbabecc23249c146db0e5c6d5f0e8e27b134238e08c4edf54b874dd1d5a0176872fd428d2e72765a86ed36f1c82600435ffc17a391a89cdc95642ce72e58ef8f6a8d13844e730c75d291e30bf4dca2137aded2207d1fc5226f90535c4758d1dc436edda9f049067bbb465c747c6001d61e52ea8e5c441ed55f4244c85b515f7fd28229641b829594e612783292440da0457df8f2ca01b837c681e9a8f34bb722082aa62b0f7a6eaaf9b874197f309707266faa9f823e2d4ded37f2a001ebbc2bc1e58a912673e088d643ee5af23a1a7aec68c383498a080b617c98af567a96510c1f5ac6988fb2cdc7a6af0ee1fd26f4e8557b441079497d91be7c59810c3148c9a479f893261e7c0c5ee008577f2718fd4aaa5ba24c4421962a05be3e0ec807f7f46aa55ca1b5bb78cf5a6bc27b0139d5e24bca1b57b1d66bd3c3ad17d6c219c85d14f8ce7311ad1f12453db020300d119d602a3bb5ed00f1b0718bbff5ff03ebe3d65f8d94200769bd1f90a4952dbd5f54d0adb5c309fe6e01fc24f9baef6c6b571c8049f234c0c139bc01a3df293805bb83f48a4c26fca011e67bf7080f01ad3151725c4a391f97a0d7b34d3517e16a4cec8a676c67a133c3d42ec2d644b05feaa6ac0ca09c44134fe77740bc19abd4a981d7fd95cebb4bee3787d9d163e57d161ded20203f5ab3f051ecfec71a4cb0716ada6eca73949c893f83a75d6a69b918604876359076cc58817baa8828a3e127b5111be026655ae8edefd79ced3e5bd05521bdbe3198404327c0408f161b6a98303867cb77b3e6ce674a457b0ecd738107db2966534797adb039b48d0d8fe6df89f67d84f42cb19b2d3799b168ef550450f878b59e4fe1bb9c8d64871e896eedc50241740c64cbab5aa2415043ef5c095529370fb03adbc6ec8e22852c7aa92729889a956df02a7fdc66db20d151805e7afb33e9d4c53ea41fa90bf822ea572c361cf6136c7d6ba50275bff40721f888216b4d19f3dd18d7768a41b2053039e17cdbd0d70721e76224f2bb5b541c03123da922b23948b98a05a92bec0eb917bf500dd0947ca27863faf9eed01a7d81852a3016bc0e1a36457ccb6632278448d6e99bd631cbd007de80ce1b693601b723a8e3b2c75f781bc2124ee7cc07a9448111bec84e4b7e79b62bd3f33a84e6bb75a03d7991422ae5a8c03344c92bfa6027b5b11e8cb910cc108498e1f18568bf79fe8e331a80eb2e810d6f750f95";

        let instances = vector[
            x"0600000000000000000000000000000000000000000000000000000000000000",
            x"0600000000000000000000000000000000000000000000000000000000000000",
            x"0600000000000000000000000000000000000000000000000000000000000000"
        ];
        let result = halo2_verifier::verify_single(&params, &protocol, vector::singleton(instances), proof_gwc, 1);
        assert!(result, 100);
        let result = halo2_verifier::verify_single(&params, &protocol, vector::singleton(instances), proof_shplonk, 0);
        assert!(result, 101);
    }
}
